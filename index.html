<html><head><base href="https://example.com" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>میزان کارکرد کارکنان اورژانس</title>
<style>
  @font-face {
    font-family: 'Vazir';
    src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir-Regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
  }
  
  body {
    font-family: 'Vazir', sans-serif;
    background-color: #e6f3ff;
    direction: rtl;
    margin: 0;
    padding: 20px;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: #ffffff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  
  h1 {
    text-align: center;
    color: #0056b3;
  }
  
  .section {
    margin-bottom: 30px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 15px;
  }
  
  .section-title {
    font-size: 1.2em;
    color: #0056b3;
    margin-bottom: 15px;
  }
  
  label {
    display: block;
    margin-bottom: 5px;
    color: #333;
  }
  
  .checkbox-container {
    display: flex;
    align-items: center;
    margin-top: 10px;
    width: 100%;
  }
  
  .checkbox-container label {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .checkbox-container input[type="checkbox"] {
    margin: 0;
    order: -1; /* This ensures the checkbox appears before the label */
  }
  
  /* Override the previous input styles for checkboxes */
  input[type="checkbox"] {
    width: auto; /* Override the 100% width set for other inputs */
  }
  
  input, select {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  
  .signature-pad {
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 300px;
    height: 150px;
  }
  
  .btn {
    background-color: #0056b3;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 10px;
  }
  
  .btn:hover {
    background-color: #003d82;
  }
  
  .table-container {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: right;
  }
  
  th {
    background-color: #f0f8ff;
    color: #0056b3;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  
  .edit-btn, .delete-btn {
    padding: 5px 10px;
    margin: 2px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  
  .edit-btn {
    background-color: #ffc107;
    color: #000;
  }
  
  .delete-btn {
    background-color: #dc3545;
    color: #fff;
  }
  
  .signature-image {
    max-width: 100px;
    max-height: 50px;
  }
  
  .date-picker {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    position: absolute;
    background-color: #fff;
    border: 1px solid #ccc;
    padding: 10px;
  }
</style>
<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-briefcase-medical"></i> میزان کارکرد کارکنان اورژانس</h1>
    
    <div class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div class="section-title"><i class="fas fa-user-tie"></i> مشخصات مسئول پایگاه</div>
        <button onclick="resetAllData()" class="btn" style="font-size: 1.1em; padding: 12px 20px;">
          <i class="fas fa-redo"></i> شروع جدید
        </button>
      </div>
      
      <label for="manager-name"><i class="fas fa-user"></i> نام مسئول پایگاه:</label>
      <input type="text" id="manager-name" name="manager-name">
      
      <label for="national-code"><i class="fas fa-id-card"></i> کد ملی:</label>
      <input type="number" id="national-code" name="national-code">
      
      <label for="signature"><i class="fas fa-signature"></i> امضا و تاریخ:</label>
      <canvas id="signature-pad" class="signature-pad"></canvas>
      <button id="clear-signature" class="btn"><i class="fas fa-eraser"></i> پاک کردن امضا</button>
      <button id="save-signature" class="btn"><i class="fas fa-save"></i> ذخیره امضا</button>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-info-circle"></i> اطلاعات پایگاه</div>
      <label for="base-name"><i class="fas fa-building"></i> نام پایگاه:</label>
      <select id="base-name" name="base-name">
        <option value="فلسطین">فلسطین</option>
        <option value="فرهنگ">فرهنگ</option>
        <option value="اسماعیلی">اسماعیلی</option>
        <option value="عاشقان">عاشقان</option>
        <option value="آهی دشت">آهی دشت</option>
        <option value="گدازنده">گدازنده</option>
        <option value="وفائیان">وفائیان</option>
        <option value="پیامبر اعظم">پیامبر اعظم</option>
        <option value="شجاع">شجاع</option>
        <option value="فرودگاه">فرودگاه</option>
        <option value="تاکام">تاکام</option>
        <option value="محمد آباد">محمد آباد</option>
        <option value="کلاج خوسه">کلاج خوسه</option>
        <option value="کیاسر">کیاسر</option>
        <option value="تلمادره">تلمادره</option>
        <option value="سورک">سورک</option>
        <option value="ولوجا">ولوجا</option>
        <option value="غیره">غیره</option>
      </select>
      
      <label for="base-type"><i class="fas fa-map-marker-alt"></i> نوع پایگاه:</label>
      <select id="base-type" name="base-type">
        <option value="شهری">شهری</option>
        <option value="جاده">جاده</option>
      </select>
      
      <label for="month"><i class="fas fa-calendar-alt"></i> ماه:</label>
      <select id="month" name="month">
        <option value="فروردین">فروردین</option>
        <option value="اردیبهشت">اردیبهشت</option>
        <option value="خرداد">خرداد</option>
        <option value="تیر">تیر</option>
        <option value="مرداد">مرداد</option>
        <option value="شهریور">شهریور</option>
        <option value="مهر">مهر</option>
        <option value="آبان">آبان</option>
        <option value="آذر">آذر</option>
        <option value="دی">دی</option>
        <option value="بهمن">بهمن</option>
        <option value="اسفند">اسفند</option>
      </select>
      
      <label for="year"><i class="fas fa-calendar"></i> سال:</label>
      <select id="year" name="year">
        <option value="1400">1400</option>
        <option value="1401">1401</option>
        <option value="1402">1402</option>
        <option value="1403">1403</option>
        <option value="1404">1404</option>
        <option value="1405">1405</option>
      </select>
    </div>
    
    <div class="section">
      <div class="section-title"><i class="fas fa-chart-line"></i> آمار کارکرد</div>
      <label for="staff-name"><i class="fas fa-user"></i> نام پرسنل:</label>
      <input type="text" id="staff-name" name="staff-name" list="staff-list">
      <datalist id="staff-list">
        <option value="محمد ابراهیم نیا عمران">
        <option value="امیر حسین احمدی">
        <option value="محمود رضا احمدیان">
        <option value="سعید اسدی">
        <option value="مهدی اصغری">
        <option value="مصطفی انصاری">
        <option value="مازیار صادقیان">
        <option value="عسگری اکبری">
        <option value="حسین کافتری">
        <option value="رضا عبدالملک">
        <option value="ابوالفضل ملک زاده">
        <option value="وحید دارابی">
        <option value="مجتبی زارع">
        <option value="معین مقصودی">
        <option value="مهدی رزاقی">
        <option value="احمدرضا ابراهیمی">
        <option value="امیرحسین قلی پور">
        <option value="میثم شیخ زاده">
        <option value="عباس کرامتی">
        <option value="مهدی فیروز">
        <option value="شهرام مسلط">
        <option value="سهیل براتی">
        <option value="جواد قادی">
        <option value="میثم آهنگران">
        <option value="محمد تقی رنجبر">
        <option value="مهران یاوری">
        <option value="سینا اولادی">
        <option value="محمد ایمانی">
        <option value="علی آهی فر">
        <option value="ابوالفضل ابراهیم زاده">
        <option value="حسن آرین">
        <option value="پیمان بهاری">
        <option value="علی بابانژاد">
        <option value="حسین بابایی">
        <option value="حسین باقری">
        <option value="مهدی بخشنده">
        <option value="علی اصغر باقریان">
        <option value="محمد بیرجندی">
        <option value="اشکان بهرامی نژاد">
        <option value="محمد باباپور">
        <option value="حسین بغیاری">
        <option value="محراب پورقاسم">
        <option value="علی پیرحیاتی">
        <option value="مرتضی تقی زاده">
        <option value="مرتضی تودرواری">
        <option value="مهدی جان زاده">
        <option value="مصطفی جعفری">
        <option value="پژمان جمالی">
        <option value="سید یاسر حسینی">
        <option value="مصطفی حیدری">
        <option value="علی خجسته راد">
        <option value="سید الیاس خدادادی">
        <option value="حامد خوش خو">
        <option value="خسرو درزی">
        <option value="مسعود دهقان">
        <option value="رجبعلی دهقانی">
        <option value="عباس ذاکری">
        <option value="هانی رجبی">
        <option value="رامین رستم پور">
        <option value="رضا رستمی">
        <option value="رحمت رضایی">
        <option value="ماهان رمضانی">
        <option value="محمدرضا رمضانی">
        <option value="علی روحی">
        <option value="علی اکبر روحانی">
        <option value="عباد روشن قیاس">
        <option value="محسن زارع">
        <option value="محمد رضا زین العابدینی">
        <option value="حامد زمانی فر">
        <option value="سید رشید ساداتی">
        <option value="میثم سرخکلایی">
        <option value="سعید شبگرد">
        <option value="علی شاکری">
        <option value="حسین شعبانی">
        <option value="امیرحسین شیخی">
        <option value="صادق شیرزاد">
        <option value="بابک شریفیان">
        <option value="امین الله صادقی">
        <option value="محسن صالحی">
        <option value="حسن طالبی">
        <option value="توکل عربی">
        <option value="احسان علینژاد">
        <option value="رضا علینژاد">
        <option value="مهدی عرب">
        <option value="محمد رضا غلامی">
        <option value="محمد غفاری">
        <option value="محمد فرزانه">
        <option value="علی فتحی">
        <option value="حسین فروزان">
        <option value="محمد قدیرنیا">
        <option value="محمد قلی نژاد">
        <option value="کیوان قدیری">
        <option value="حسین لازری">
        <option value="محسن لازری">
        <option value="سید علی کرمی">
        <option value="سید مهران کاظمی">
        <option value="طه کاکویی">
        <option value="افشین کاکویی">
        <option value="صابر کاکویی">
        <option value="سامان کروبیان">
        <option value="محمدحسین کهنسال">
        <option value="عبدالله کارگر">
        <option value="محمد کجوری">
        <option value="امیرحسین کلانتری">
        <option value="محسن کریمی">
        <option value="مهدی کمالی">
        <option value="شعیب کلبادی نژاد">
        <option value="میثم گوران">
        <option value="حسن مسلمی">
        <option value="ناصر محبی">
        <option value="علی محمد محسنی">
        <option value="محمد محسنی">
        <option value="محمد محمدپور">
        <option value="سید حامد محمدی">
        <option value="فرهاد موسوی">
        <option value="سید رضا محمودی">
        <option value="علی محمودی">
        <option value="سید محمد مهدی مرادی">
        <option value="مهدی معافی">
        <option value="ابراهیم مهدوی">
        <option value="عبدالرضا نامی">
        <option value="ناصر نبوی">
        <option value="محمد نصرتی">
        <option value="امیر نصراللهی">
        <option value="روح الله نوروزیان">
        <option value="احسان نورپور">
        <option value="مهدی نوروزی">
        <option value="سید جواد هاشمی">
        <option value="منوچهر وطن پور">
        <option value="احمد وفائی مقدم">
        <option value="محمد یعقوبی">
        <option value="علی اکبر یوسفی">
        <option value="میلاد یونسی">
        <option value="بهنام یونسی">
        <option value="محسن اصغری">
        <option value="ابوالفضل عابد">
        <option value="یعقوب اسماعیلی">
        <option value="حمید تقی نیا">
        <option value="حسین قادی">
        <option value="اسماعیل محمدی">
        <option value="علیرضا دهقان زاده">
        <option value="حافظ شیرازی">
        <option value="میلاد سهیل جو">
        <option value="جابر مدانلو">
        <option value="محمد فردوسی">
        <option value="امیرمحمد رضایی">
        <option value="بشیر فدایی">
        <option value="روح الله کوثری">
        <option value="یوسف فرامرزی">
        <option value="امیر جان بابانژاد">
        <option value="عباس یونسی">
      </datalist>
      <div class="checkbox-container">
        <input type="checkbox" id="productive" name="productive">
        <label for="productive" style="margin-right: 10px;">
          بهره ور
        </label>
      </div>
      
      <div class="shift-section">
        <div class="shift-item">
          <label>شیفت ۲۴ عادی:</label>
          <input type="number" id="normal-24-count" name="normal-24-count" placeholder="تعداد">
          <input type="text" id="normal-24-date" name="normal-24-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>شیفت ۲۴ تعطیل:</label>
          <input type="number" id="holiday-24-count" name="holiday-24-count" placeholder="تعداد">
          <input type="text" id="holiday-24-date" name="holiday-24-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>لانگ عادی:</label>
          <input type="number" id="long-day-count" name="long-day-count" placeholder="تعداد">
          <input type="text" id="long-day-date" name="long-day-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>لانگ تعطیل:</label>
          <input type="number" id="holiday-long-day-count" name="holiday-long-day-count" placeholder="تعداد">
          <input type="text" id="holiday-long-day-date" name="holiday-long-day-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>شب:</label>
          <input type="number" id="night-count" name="night-count" placeholder="تعداد">
          <input type="text" id="night-date" name="night-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>شب تعطیل (مخصوص غیر بهره ور):</label>
          <input type="number" id="holiday-night-count" name="holiday-night-count" placeholder="تعداد">
          <input type="text" id="holiday-night-date" name="holiday-night-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>مرخصی کامل:</label>
          <input type="number" id="full-leave-count" name="full-leave-count" placeholder="تعداد">
          <input type="text" id="full-leave-date" name="full-leave-date" placeholder="تاریخ" readonly>
        </div>
        <div class="shift-item">
          <label>مرخصی استعلاجی:</label>
          <input type="number" id="medical-leave-count" name="medical-leave-count" placeholder="تعداد">
          <input type="text" id="medical-leave-date" name="medical-leave-date" placeholder="تاریخ" readonly>
        </div>
      </div>
      
      <div class="additional-items">
        <label for="additional-item"><i class="fas fa-plus-circle"></i> موارد تکمیلی:</label>
        <select id="additional-item" name="additional-item">
          <option value="ساعات اضافه متفرقه">ساعات اضافه متفرقه</option>
          <option value="مرخصی ساعتی">مرخصی ساعتی</option>
          <option value="کسری">کسری</option>
          <option value="استقرار">استقرار</option>
          <option value="اعزام">اعزام</option>
          <option value="متفرقه">متفرقه</option>
        </select>
        <button id="add-item" class="btn" style="margin-bottom: 20px;"><i class="fas fa-plus"></i> افزودن مورد</button>
      </div>
      
      <div id="additional-fields"></div>
      
      <label for="notes"><i class="fas fa-sticky-note"></i> ملاحظات:</label>
      <input type="text" id="notes" name="notes">
      
      <label for="mission-count"><i class="fas fa-tasks"></i> تعداد ماموریت:</label>
      <input type="number" id="mission-count" name="mission-count">
      
      <label for="meal-count"><i class="fas fa-utensils"></i> تعداد وعده غذا:</label>
      <input type="number" id="meal-count" name="meal-count">
    </div>
    
    <button id="submit" class="btn"><i class="fas fa-check"></i> ثبت</button>
    <button id="save-changes" class="btn"><i class="fas fa-save"></i> ذخیره تغییرات</button>
    
    <button id="clear-temp-data" class="btn"><i class="fas fa-trash"></i> حذف داده‌های موقت</button>
    <button id="reset-all" class="btn"><i class="fas fa-redo"></i> شروع جدید</button>
    
    
    <div id="results" style="display: none;">
      <h2><i class="fas fa-chart-bar"></i> نتایج</h2>
      <div class="table-container">
        <table id="table1">
          <thead>
            <tr>
              <th>نام پایگاه</th>
              <th>نوع پایگاه</th>
              <th>نام مسئول پایگاه</th>
              <th>کد ملی</th>
              <th>ماه و سال</th>
              <th>امضا</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="table-container">
        <table id="table2">
          <thead>
            <tr>
              <th>نام پرسنل</th>
              <th>بهره ور</th>
              <th>نوع پایگاه</th>
              <th>نام پایگاه</th>
              <th>ماه و سال</th>
              <th>۲۴ عادی</th>
              <th>۲۴ تعطیل</th>
              <th>لانگ عادی</th>
              <th>لانگ تعطیل</th>
              <th>شب</th>
              <th>شب تعطیل</th>
              <th>مرخصی کامل</th>
              <th>مرخصی استعلاجی</th>
              <th>ساعات اضافه متفرقه</th>
              <th>مرخصی ساعتی</th>
              <th>کسری</th>
              <th>استقرار</th>
              <th>اعزام</th>
              <th>متفرقه</th>
              <th>تعداد ماموریت</th>
              <th>تعداد وعده غذا</th>
              <th>ملاحظات</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="table-container">
        <table id="table3">
          <thead>
            <tr>
              <th>نام پرسنل</th>
              <th>نام پایگاه</th>
              <th>بهره ور</th>
              <th>تاریخ ۲۴ عادی</th>
              <th>تاریخ ۲۴ تعطیل</th>
              <th>تاریخ لانگ عادی</th>
              <th>تاریخ لانگ تعطیل</th>
              <th>تاریخ شب</th>
              <th>تاریخ شب تعطیل</th>
              <th>تاریخ مرخصی کامل</th>
              <th>تاریخ مرخصی استعلاجی</th>
              <th>تاریخ ساعات اضافی متفرقه</th>
              <th>تاریخ مرخصی ساعتی</th>
              <th>تاریخ کسری</th>
              <th>تاریخ استقرار</th>
              <th>تاریخ اعزام</th>
              <th>تاریخ متفرقه</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Replace the existing share button section with this -->
    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
      <button id="share-button" class="btn">
        <i class="fas fa-share-alt"></i> اشتراک‌گذاری
      </button>
      <button id="download-button" class="btn">
        <i class="fas fa-download"></i> دانلود فایل‌ها
      </button>
    </div>
  </div>

  <!-- Add Font Awesome for the share icon -->
  <script src="https://kit.fontawesome.com/a076d05399.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    let isFirstSubmission = true;
    let currentEditRow = null;
    let signaturePad;
    let savedSignature = null;

    document.addEventListener('DOMContentLoaded', function() {
      signaturePad = new SignaturePad(document.getElementById('signature-pad'));
      
      document.getElementById('clear-signature').addEventListener('click', function() {
        signaturePad.clear();
        savedSignature = null;
        document.getElementById('signature-pad').style.pointerEvents = 'auto';
      });
      
      document.getElementById('save-signature').addEventListener('click', function() {
        if (signaturePad.isEmpty()) {
          alert('لطفا ابتدا امضا کنید');
        } else {
          savedSignature = signaturePad.toDataURL();
          alert('امضا با موفقیت ذخیره شد');
          document.getElementById('signature-pad').style.pointerEvents = 'none';
        }
      });
      
      const dateInputs = document.querySelectorAll('input[type="text"][readonly]');
      dateInputs.forEach(input => {
        input.addEventListener('click', function() {
          showDatePicker(this);
        });
      });
      
      document.getElementById('add-item').addEventListener('click', addAdditionalItem);
      
      document.getElementById('submit').addEventListener('click', submitForm);
      document.getElementById('save-changes').addEventListener('click', saveChanges);

      // Add share button event listener
      document.getElementById('share-button').addEventListener('click', shareData);

      // Add download button event listener
      document.getElementById('download-button').addEventListener('click', downloadAllFilesDirectly);

      // Load saved data from localStorage
      loadTempData();
      loadTableData();

      // Add event listener for saving temp data
      // document.getElementById('save-temp-data').addEventListener('click', saveTempData);

      // Add event listener for clearing temp data
      document.getElementById('clear-temp-data').addEventListener('click', clearTempData);

      // Add event listener for resetting all data
      document.getElementById('reset-all').addEventListener('click', resetAllData);

      // Add event listener for loading last tables
      document.getElementById('load-last-tables').addEventListener('click', loadTableData);

      // Auto-save when inputs change
      const inputs = document.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('change', saveTempData);
        input.addEventListener('blur', saveTempData);
      });
      
      // Save before page unload
      window.addEventListener('beforeunload', saveTempData);
    });
    
    function showDatePicker(input) {
      const datePicker = document.createElement('div');
      datePicker.className = 'date-picker';
      datePicker.style.position = 'absolute';
      datePicker.style.backgroundColor = '#fff';
      datePicker.style.border = '1px solid #ccc';
      datePicker.style.padding = '10px';
      
      const selectedDates = input.value && input.value !== '-' ? input.value.split(',').map(Number) : [];
      
      for (let i = 1; i <= 31; i++) {
        const day = document.createElement('span');
        day.textContent = i;
        day.style.display = 'inline-block';
        day.style.textAlign = 'center';
        day.style.cursor = 'pointer';
        day.style.width = '25px';
        day.style.height = '25px';
        day.style.lineHeight = '25px';
        day.style.border = '1px solid #ccc';
        day.style.borderRadius = '50%';
        
        if (selectedDates.includes(i)) {
          day.style.backgroundColor = '#007bff';
          day.style.color = '#fff';
        }
        
        day.addEventListener('click', function() {
          const currentValue = input.value && input.value !== '-' ? input.value.split(',') : [];
          if (currentValue.includes(i.toString())) {
            currentValue.splice(currentValue.indexOf(i.toString()), 1);
            day.style.backgroundColor = '';
            day.style.color = '';
          } else {
            currentValue.push(i);
            day.style.backgroundColor = '#007bff';
            day.style.color = '#fff';
          }
          input.value = currentValue.length > 0 ? currentValue.sort((a, b) => a - b).join(',') : '-';
        });
        
        datePicker.appendChild(day);
      }
      
      input.parentNode.appendChild(datePicker);
      
      document.addEventListener('click', function closeDatePicker(e) {
        if (e.target !== input && !datePicker.contains(e.target)) {
          datePicker.remove();
          document.removeEventListener('click', closeDatePicker);
        }
      });
    }
    
    function addAdditionalItem() {
      const additionalItem = document.getElementById('additional-item').value;
      const additionalFields = document.getElementById('additional-fields');
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'additional-item';
      itemDiv.dataset.category = additionalItem; // Store the category for reference
      
      itemDiv.innerHTML = `
        <div style="margin-bottom: 10px;">
          <label style="display: block;">عنوان ${additionalItem}:</label>
          <input type="text" name="${additionalItem}-title" value="" placeholder="عنوان را وارد کنید">
        </div>
        <div style="margin-bottom: 10px;">
          <label style="display: block;">میزان:</label>
          <input type="number" name="${additionalItem}-count" placeholder="میزان به ساعت" >
        </div>
        <div style="margin-bottom: 10px;">
          <label style="display: block;">تاریخ:</label>
          <input type="text" name="${additionalItem}-date" placeholder="تاریخ" readonly>
        </div>
        <button class="delete-btn" style="margin-bottom: 20px;">حذف</button>
        <hr>
      `;
      
      additionalFields.appendChild(itemDiv);
      
      itemDiv.querySelector('input[type="text"][readonly]').addEventListener('click', function() {
        showDatePicker(this);
      });
      
      itemDiv.querySelector('.delete-btn').addEventListener('click', function() {
        itemDiv.remove();
      });
    }
    
    function submitForm() {
      const table1Body = document.querySelector('#table1 tbody');
      const table2Body = document.querySelector('#table2 tbody');
      const table3Body = document.querySelector('#table3 tbody');

      if (isFirstSubmission) {
        table1Body.innerHTML = `
          <tr>
            <td>${document.getElementById('base-name').value}</td>
            <td>${document.getElementById('base-type').value}</td>
            <td>${document.getElementById('manager-name').value}</td>
            <td>${document.getElementById('national-code').value}</td>
            <td>${document.getElementById('month').value} ${document.getElementById('year').value}</td>
            <td>${savedSignature ? `<img src="${savedSignature}" alt="امضا" class="signature-image">` : 'امضا نشده'}</td>
          </tr>
        `;
        
        disableFirstSevenFields();
        
        savedSignature = signaturePad.toDataURL();
        document.getElementById('signature-pad').style.pointerEvents = 'none';
        document.getElementById('clear-signature').disabled = true;
        document.getElementById('save-signature').disabled = true;

        isFirstSubmission = false;
      }

      if (currentEditRow) {
        alert('لطفا ابتدا تغیرات را ذخیره کنید یا ثبت جدی انجام دهید.');
        return;
      }

      const staffName = document.getElementById('staff-name').value;
      const productive = document.getElementById('productive').checked ? 'بله' : 'خیر';
      const baseType = document.getElementById('base-type').value;
      const baseName = document.getElementById('base-name').value;
      const monthYear = `${document.getElementById('month').value} ${document.getElementById('year').value}`;
      const notes = document.getElementById('notes').value || '-';
      const missionCount = document.getElementById('mission-count').value || 0;
      const mealCount = document.getElementById('meal-count').value || 0;

      const shiftCounts = {
        'normal-24-count': document.getElementById('normal-24-count').value || 0,
        'holiday-24-count': document.getElementById('holiday-24-count').value || 0,
        'long-day-count': document.getElementById('long-day-count').value || 0,
        'holiday-long-day-count': document.getElementById('holiday-long-day-count').value || 0,
        'night-count': document.getElementById('night-count').value || 0,
        'holiday-night-count': document.getElementById('holiday-night-count').value || 0,
        'full-leave-count': document.getElementById('full-leave-count').value || 0,
        'medical-leave-count': document.getElementById('medical-leave-count').value || 0
      };

      // Group items by category
      const groupedItems = {};
      document.querySelectorAll('#additional-fields .additional-item').forEach(itemDiv => {
        const category = itemDiv.dataset.category;
        const title = itemDiv.querySelector('input[name$="-title"]').value.trim();
        const count = parseInt(itemDiv.querySelector('input[name$="-count"]').value) || 0;
        const date = itemDiv.querySelector('input[name$="-date"]').value || '-';
        
        if (!groupedItems[category]) {
          groupedItems[category] = {
            totalCount: 0,
            entries: []
          };
        }
        
        groupedItems[category].totalCount += count;
        if (title && date !== '-') {
          groupedItems[category].entries.push(`${title}-${date}`);
        }
      });

      // Generate table cells
      const additionalCountsHtml = [
        'ساعات اضافه متفرقه',
        'مرخصی ساعتی',
        'کسری',
        'استقرار',
        'اعزام',
        'متفرقه'
      ].map(category => 
        `<td>${groupedItems[category]?.totalCount || 0}</td>`
      ).join('');

      const additionalDatesHtml = [
        'ساعات اضافه متفرقه',
        'مرخصی ساعتی',
        'کسری',
        'استقرار',
        'اعزام',
        'متفرقه'
      ].map(category => 
        `<td>${groupedItems[category]?.entries.length > 0 ? groupedItems[category].entries.join(', ') : '-'}</td>`
      ).join('');

      table2Body.innerHTML += `
        <tr>
          <td>${staffName}</td>
          <td>${productive}</td>
          <td>${baseType}</td>
          <td>${baseName}</td>
          <td>${monthYear}</td>
          <td>${shiftCounts['normal-24-count']}</td>
          <td>${shiftCounts['holiday-24-count']}</td>
          <td>${shiftCounts['long-day-count']}</td>
          <td>${shiftCounts['holiday-long-day-count']}</td>
          <td>${shiftCounts['night-count']}</td>
          <td>${shiftCounts['holiday-night-count']}</td>
          <td>${shiftCounts['full-leave-count']}</td>
          <td>${shiftCounts['medical-leave-count']}</td>
          ${additionalCountsHtml}
          <td>${missionCount}</td>
          <td>${mealCount}</td>
          <td>${notes}</td>
          <td>
            <button class="edit-btn">ویرایش</button>
            <button class="delete-btn">حذف</button>
          </td>
        </tr>
      `;

      table3Body.innerHTML += `
        <tr>
          <td>${staffName}</td>
          <td>${baseName}</td>
          <td>${productive}</td>
          <td>${document.getElementById('normal-24-date').value || '-'}</td>
          <td>${document.getElementById('holiday-24-date').value || '-'}</td>
          <td>${document.getElementById('long-day-date').value || '-'}</td>
          <td>${document.getElementById('holiday-long-day-date').value || '-'}</td>
          <td>${document.getElementById('night-date').value || '-'}</td>
          <td>${document.getElementById('holiday-night-date').value || '-'}</td>
          <td>${document.getElementById('full-leave-date').value || '-'}</td>
          <td>${document.getElementById('medical-leave-date').value || '-'}</td>
          ${additionalDatesHtml}
          <td>
            <button class="edit-btn">ویرایش</button>
            <button class="delete-btn">حذف</button>
          </td>
        </tr>
      `;

      table2Body.querySelectorAll('.edit-btn').forEach(btn => {
        btn.removeEventListener('click', editRow);
        btn.addEventListener('click', editRow);
      });

      table3Body.querySelectorAll('.edit-btn').forEach(btn => {
        btn.removeEventListener('click', editRow);
        btn.addEventListener('click', editRow);
      });

      table2Body.querySelectorAll('.delete-btn').forEach(btn => {
        btn.removeEventListener('click', deleteRow);
        btn.addEventListener('click', deleteRow);
      });

      table3Body.querySelectorAll('.delete-btn').forEach(btn => {
        btn.removeEventListener('click', deleteRow);
        btn.addEventListener('click', deleteRow);
      });

      document.getElementById('results').style.display = 'block';
      
      // Save table data after submission
      saveTableData();
      
      clearSubmissionFields();
    }

    function saveChanges() {
      if (!currentEditRow) {
        alert('هیچ ردیفی برای ویرایش انتخاب نشده است.');
        return;
      }

      const table2Row = currentEditRow;
      const table3Row = document.querySelector(`#table3 tbody tr:nth-child(${Array.from(table2Row.parentNode.children).indexOf(table2Row) + 1})`);

      // Update common fields
      table2Row.cells[0].textContent = document.getElementById('staff-name').value;
      table2Row.cells[1].textContent = document.getElementById('productive').checked ? 'بله' : 'خیر';
      table2Row.cells[2].textContent = document.getElementById('base-type').value;
      table2Row.cells[3].textContent = document.getElementById('base-name').value;
      table2Row.cells[4].textContent = `${document.getElementById('month').value} ${document.getElementById('year').value}`;

      // Update shift counts and dates
      const shiftFields = [
        'normal-24', 'holiday-24', 'long-day', 'holiday-long-day',
        'night', 'holiday-night', 'full-leave', 'medical-leave'
      ];

      shiftFields.forEach((field, index) => {
        const countValue = document.getElementById(`${field}-count`).value || '0';
        const dateValue = document.getElementById(`${field}-date`).value || '-';
        table2Row.cells[5 + index].textContent = countValue;
        table3Row.cells[3 + index].textContent = dateValue;
      });

      // Update additional items (موارد تکمیلی)
      const additionalItemNames = ['ساعات اضافه متفرقه', 'مرخصی ساعتی', 'کسری', 'استقرار', 'اعزام', 'متفرقه'];
      const additionalFields = document.getElementById('additional-fields');
      
      // Initialize objects to store aggregated data
      const aggregatedCounts = {};
      const aggregatedDates = {};
      additionalItemNames.forEach(name => {
        aggregatedCounts[name] = 0;
        aggregatedDates[name] = [];
      });

      // Collect data from all additional items
      additionalFields.querySelectorAll('.additional-item').forEach(item => {
        const category = item.dataset.category;
        const count = parseInt(item.querySelector(`input[name="${category}-count"]`).value) || 0;
        const date = item.querySelector(`input[name="${category}-date"]`).value;
        const title = item.querySelector(`input[name="${category}-title"]`).value.trim();

        aggregatedCounts[category] += count;
        if (title && date && date !== '-') {
          aggregatedDates[category].push(`${title}-${date}`);
        }
      });

      // Update table cells with aggregated data
      additionalItemNames.forEach((category, index) => {
        // Update counts in table2
        table2Row.cells[13 + index].textContent = aggregatedCounts[category];
        
        // Update dates in table3
        const dateCell = table3Row.cells[11 + index];
        dateCell.textContent = aggregatedDates[category].length > 0 ? 
          aggregatedDates[category].join(', ') : 
          '-';
      });

      // Update remaining fields
      table2Row.cells[19].textContent = document.getElementById('mission-count').value || '0';
      table2Row.cells[20].textContent = document.getElementById('meal-count').value || '0';
      table2Row.cells[21].textContent = document.getElementById('notes').value || '-';

      alert('تغییرات با موفقیت ذخیره شد.');

      // Reset editing state and clear form
      currentEditRow = null;
      table3Row.classList.remove('editing');
      clearSubmissionFields();
      
      // Save updated table data
      saveTableData();
    }

    function editRow(event) {
      const row = event.target.closest('tr');
      const table = row.closest('table');
      const isTable2 = table.id === 'table2';
      currentEditRow = isTable2 ? row : document.querySelector(`#table2 tbody tr:nth-child(${Array.from(row.parentNode.children).indexOf(row) + 1})`);
      const table3Row = isTable2 ? document.querySelector(`#table3 tbody tr:nth-child(${Array.from(row.parentNode.children).indexOf(row) + 1})`) : row;

      document.getElementById('staff-name').value = currentEditRow.cells[0].textContent;
      document.getElementById('productive').checked = currentEditRow.cells[1].textContent === 'بله';
      document.getElementById('base-type').value = currentEditRow.cells[2].textContent;
      document.getElementById('base-name').value = currentEditRow.cells[3].textContent;
      
      const monthYear = currentEditRow.cells[4].textContent.split(' ');
      document.getElementById('month').value = monthYear[0];
      document.getElementById('year').value = monthYear[1];
      
      document.getElementById('normal-24-count').value = currentEditRow.cells[5].textContent;
      document.getElementById('holiday-24-count').value = currentEditRow.cells[6].textContent;
      document.getElementById('long-day-count').value = currentEditRow.cells[7].textContent;
      document.getElementById('holiday-long-day-count').value = currentEditRow.cells[8].textContent;
      document.getElementById('night-count').value = currentEditRow.cells[9].textContent;
      document.getElementById('holiday-night-count').value = currentEditRow.cells[10].textContent;
      document.getElementById('full-leave-count').value = currentEditRow.cells[11].textContent;
      document.getElementById('medical-leave-count').value = currentEditRow.cells[12].textContent;
      
      document.getElementById('normal-24-date').value = table3Row.cells[3].textContent;
      document.getElementById('holiday-24-date').value = table3Row.cells[4].textContent;
      document.getElementById('long-day-date').value = table3Row.cells[5].textContent;
      document.getElementById('holiday-long-day-date').value = table3Row.cells[6].textContent;
      document.getElementById('night-date').value = table3Row.cells[7].textContent;
      document.getElementById('holiday-night-date').value = table3Row.cells[8].textContent;
      document.getElementById('full-leave-date').value = table3Row.cells[9].textContent;
      document.getElementById('medical-leave-date').value = table3Row.cells[10].textContent;
      
      document.getElementById('additional-fields').innerHTML = '';
      
      const additionalItemNames = ['ساعات اضافه متفرقه', 'مرخصی ساعتی', 'کسری', 'استقرار', 'اعزام', 'متفرقه'];
      additionalItemNames.forEach((category, index) => {
        const count = currentEditRow.cells[13 + index].textContent;
        const dateCell = table3Row.cells[11 + index].textContent;
        
        if (dateCell && dateCell !== '-') {
          const entries = dateCell.split(', ');
          entries.forEach(entry => {
            const [title, date] = entry.split('-');
            
            document.getElementById('additional-item').value = category;
            addAdditionalItem();
            
            const lastAdded = document.querySelector('#additional-fields .additional-item:last-child');
            lastAdded.querySelector(`input[name="${category}-title"]`).value = title;
            lastAdded.querySelector(`input[name="${category}-count"]`).value = 
              Math.floor(parseInt(count) / entries.length) || 0;
            lastAdded.querySelector(`input[name="${category}-date"]`).value = date;
          });
        }
      });
      
      document.getElementById('mission-count').value = currentEditRow.cells[19].textContent;
      document.getElementById('meal-count').value = currentEditRow.cells[20].textContent;
      
      document.getElementById('notes').value = currentEditRow.cells[21].textContent;
      
      const table3Rows = document.querySelectorAll('#table3 tbody tr');
      table3Rows.forEach((row, index) => {
        if (index === Array.from(currentEditRow.parentNode.children).indexOf(currentEditRow)) {
          row.classList.add('editing');
        } else {
          row.classList.remove('editing');
        }
      });
    }

    function deleteRow(event) {
      const row = event.target.closest('tr');
      const table2Index = Array.from(row.parentNode.children).indexOf(row);
      
      row.remove();
      
      const table3Row = document.querySelector(`#table3 tbody tr:nth-child(${table2Index + 1})`);
      if (table3Row) {
        table3Row.remove();
      }
    }

    function disableFirstSevenFields() {
      document.getElementById('manager-name').disabled = true;
      document.getElementById('national-code').disabled = true;
      document.getElementById('base-name').disabled = true;
      document.getElementById('base-type').disabled = true;
      document.getElementById('month').disabled = true;
      document.getElementById('year').disabled = true;
      document.getElementById('signature-pad').style.pointerEvents = 'none';
      document.getElementById('save-signature').disabled = true;
      document.getElementById('clear-signature').disabled = true;
    }

    function clearSubmissionFields() {
      // Clear all fields except the ones we want to keep
      document.getElementById('staff-name').value = '';
      document.getElementById('productive').checked = false;
      
      const shiftCounts = ['normal-24-count', 'holiday-24-count', 'long-day-count', 'holiday-long-day-count', 'night-count', 'holiday-night-count', 'full-leave-count', 'medical-leave-count'];
      shiftCounts.forEach(id => {
        document.getElementById(id).value = '';
      });
      
      const dateFields = ['normal-24-date', 'holiday-24-date', 'long-day-date', 'holiday-long-day-date', 'night-date', 'holiday-night-date', 'full-leave-date', 'medical-leave-date'];
      dateFields.forEach(id => {
        document.getElementById(id).value = '';
      });

      const additionalFields = document.getElementById('additional-fields');
      additionalFields.innerHTML = '';
      
      document.getElementById('notes').value = '';
      document.getElementById('mission-count').value = '';
      document.getElementById('meal-count').value = '';
      
      const signaturePad = new SignaturePad(document.getElementById('signature-pad'));
      signaturePad.clear();
    }

    // Add these new functions for file generation
    function getFileName() {
      const baseName = document.getElementById('base-name').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const managerName = document.getElementById('manager-name').value;
      return `آمار کارکرد (${baseName}، ${month} ${year}، ${managerName})`;
    }

    function tablesToTXT() {
      const tables = ['table1', 'table2', 'table3'];
      let content = '\ufeff'; // Add BOM for Persian character support

      tables.forEach((tableId, index) => {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tr');
        
        if (index > 0) {
          content += '\n\n--- جدول ' + (index + 1) + ' ---\n';
        }

        rows.forEach(row => {
          const cells = row.querySelectorAll('th, td');
          const rowData = Array.from(cells)
            .map(cell => cell.textContent.trim())
            .join('\t');
          content += rowData + '\n';
        });
      });

      return content;
    }

    function tablesToCSV(tableId = null) {
      let content = '\ufeff'; // Add BOM for Persian character support
      const tables = tableId ? [tableId] : ['table1', 'table2', 'table3'];

      tables.forEach((id, index) => {
        const table = document.getElementById(id);
        const rows = table.querySelectorAll('tr');
        
        if (!tableId && index > 0) {
          content += '\n\n--- جدول ' + (index + 1) + ' ---\n';
        }

        rows.forEach(row => {
          const cells = row.querySelectorAll('th, td');
          const rowData = Array.from(cells)
            .map(cell => {
              let content = cell.textContent.trim();
              content = content.replace(/"/g, '""');
              return `"${content}"`;
            })
            .join(',');
          content += rowData + '\n';
        });
      });

      return content;
    }

    // Add this new function to convert tables to an image
    function tablesToImage() {
      return new Promise((resolve) => {
        // Create a container div for all tables
        const container = document.createElement('div');
        container.style.backgroundColor = 'white';
        container.style.padding = '20px';
        container.style.direction = 'rtl';
        
        // Clone all tables
        ['table1', 'table2', 'table3'].forEach((tableId, index) => {
          const tableClone = document.getElementById(tableId).cloneNode(true);
          
          // Remove action buttons from the cloned table
          tableClone.querySelectorAll('.edit-btn, .delete-btn').forEach(btn => btn.remove());
          
          // Add some spacing between tables
          if (index > 0) {
            container.appendChild(document.createElement('br'));
            container.appendChild(document.createElement('br'));
          }
          
          container.appendChild(tableClone);
        });

        // Temporarily add the container to the document
        document.body.appendChild(container);

        // Use html2canvas to convert the container to an image
        html2canvas(container, {
          scale: 2, // Higher resolution
          useCORS: true,
          backgroundColor: '#ffffff'
        }).then(canvas => {
          // Remove the temporary container
          document.body.removeChild(container);
          
          // Convert canvas to blob
          canvas.toBlob(blob => {
            resolve(blob);
          }, 'image/png', 1.0);
        });
      });
    }

    // Update the sharing function
    async function shareData() {
      const baseFileName = getFileName();
      
      try {
        // Show loading state
        const shareBtn = document.getElementById('share-button');
        const originalText = shareBtn.innerHTML;
        shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال آماده‌سازی...';
        shareBtn.disabled = true;

        // Create files
        const imageBlob = await tablesToImage();
        const csvBlob = new Blob([tablesToCSV()], { type: 'text/csv;charset=utf-8' });
        const csv2Blob = new Blob([tablesToCSV('table2')], { type: 'text/csv;charset=utf-8' });

        const files = [
          new File([imageBlob], `${baseFileName}.png`, { type: 'image/png' }),
          new File([csvBlob], `${baseFileName}.csv`, { type: 'text/csv' }),
          new File([csv2Blob], `${baseFileName} - جدول 2.csv`, { type: 'text/csv' })
        ];

        // Try different sharing methods
        const shareSuccess = await trySharing(files);
        
        if (!shareSuccess) {
          // If sharing fails, show a custom share menu
          showEnhancedShareMenu(files);
        }

      } catch (error) {
        console.error('Share error:', error);
        alert('خطا در اشتراک‌گذاری. در حال دانلود فایل‌ها...');
        downloadAllFiles(...files);
      } finally {
        // Restore button state
        const shareBtn = document.getElementById('share-button');
        shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> اشتراک‌گذاری';
        shareBtn.disabled = false;
      }
    }

    async function trySharing(files) {
      // 1. Try Web Share API Level 2 (files support)
      if (navigator.share && navigator.canShare) {
        try {
          const shareData = {
            files: files,
            title: 'آمار کارکرد اورژانس',
            text: 'گزارش آمار کارکرد کارکنان اورژانس'
          };

          if (navigator.canShare(shareData)) {
            await navigator.share(shareData);
            return true;
          }
        } catch (e) {
          console.log('Web Share API Level 2 failed:', e);
        }
      }

      // 2. Try Web Share API Level 1 (no files)
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'آمار کارکرد اورژانس',
            text: 'گزارش آمار کارکرد کارکنان اورژانس',
            url: window.location.href
          });
          // Download files after sharing
          setTimeout(() => downloadAllFiles(...files), 1000);
          return true;
        } catch (e) {
          console.log('Web Share API Level 1 failed:', e);
        }
      }

      return false;
    }

    function showEnhancedShareMenu(files) {
      // Create modal container
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      `;

      // Create menu container
      const menu = document.createElement('div');
      menu.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        direction: rtl;
      `;

      // Add share options
      const shareOptions = [
        { id: 'whatsapp', icon: 'fab fa-whatsapp', text: 'واتساپ', color: '#25D366' },
        { id: 'telegram', icon: 'fab fa-telegram', text: 'تلگرام', color: '#0088cc' },
        { id: 'email', icon: 'fas fa-envelope', text: 'ایمیل', color: '#EA4335' },
        { id: 'copy', icon: 'fas fa-copy', text: 'کپی لینک', color: '#6c757d' },
        { id: 'download', icon: 'fas fa-download', text: 'دانلود مستقیم', color: '#28a745' }
      ];

      menu.innerHTML = `
        <h3 style="text-align: center; margin: 0 0 20px 0;">اشتراک‌گذاری</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
          ${shareOptions.map(option => `
            <button class="share-option" data-id="${option.id}" style="
              background: none;
              border: none;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 5px;
              cursor: pointer;
              padding: 10px;
              border-radius: 10px;
              transition: background-color 0.2s;
            ">
              <i class="${option.icon}" style="font-size: 24px; color: ${option.color};"></i>
              <span style="font-size: 12px;">${option.text}</span>
            </button>
          `).join('')}
        </div>
        <button style="
          width: 100%;
          margin-top: 20px;
          padding: 10px;
          border: none;
          background: #f8f9fa;
          border-radius: 10px;
          cursor: pointer;
        " onclick="this.closest('.share-modal').remove()">لغو</button>
      `;

      // Add hover effect
      const style = document.createElement('style');
      style.textContent = `
        .share-option:hover {
          background-color: #f8f9fa;
        }
      `;
      document.head.appendChild(style);

      // Add click handlers
      menu.querySelectorAll('.share-option').forEach(button => {
        button.addEventListener('click', () => {
          handleEnhancedShare(button.dataset.id, files);
          modal.remove();
        });
      });

      modal.classList.add('share-modal');
      modal.appendChild(menu);
      document.body.appendChild(modal);

      // Close on outside click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    async function handleEnhancedShare(method, files) {
      const text = 'گزارش آمار کارکرد کارکنان اورژانس';
      const subject = 'آمار کارکرد اورژانس';

      try {
        switch (method) {
          case 'whatsapp':
          case 'telegram':
          case 'email':
            // Try to share files using Web Share API first
            const shareData = {
              files: files,
              title: subject,
              text: text
            };

            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
              try {
                await navigator.share(shareData);
                return;
              } catch (e) {
                console.log('Native share failed, trying alternative method');
              }
            }

            // If native sharing fails, try sharing through a blob URL
            const filesArray = await Promise.all(files.map(async (file) => {
              const blob = new Blob([await file.arrayBuffer()], { type: file.type });
              return {
                url: URL.createObjectURL(blob),
                name: file.name,
                type: file.type
              };
            }));

            // Create a form to post the files
            const form = document.createElement('form');
            form.style.display = 'none';
            form.method = 'post';
            form.enctype = 'multipart/form-data';

            switch (method) {
              case 'whatsapp':
                form.action = 'whatsapp://send';
                break;
              case 'telegram':
                form.action = 'tg://msg';
                break;
              case 'email':
                form.action = `mailto:?subject=${encodeURIComponent(subject)}`;
                break;
            }

            // Add files to form
            filesArray.forEach(file => {
              const input = document.createElement('input');
              input.type = 'file';
              input.name = 'file';
              
              // Create a new File object from the blob
              const fileFromBlob = new File([file], file.name, { type: file.type });
              
              // Create a DataTransfer object and add the file
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(fileFromBlob);
              input.files = dataTransfer.files;
              
              form.appendChild(input);
            });

            // Add text content
            const textInput = document.createElement('input');
            textInput.type = 'hidden';
            textInput.name = 'text';
            textInput.value = text;
            form.appendChild(textInput);

            // Submit form
            document.body.appendChild(form);
            form.submit();

            // Cleanup
            setTimeout(() => {
              filesArray.forEach(file => URL.revokeObjectURL(file.url));
              document.body.removeChild(form);
            }, 1000);

            break;

          case 'copy':
            try {
              // Create a text representation of the files
              const filesList = files.map(f => f.name).join('\n');
              const clipboardText = `${text}\n\nFiles:\n${filesList}`;
              
              await navigator.clipboard.writeText(clipboardText);
              alert('لینک و لیست فایل‌ها با موفقیت کپی شد');
              downloadAllFiles(...files);
            } catch (e) {
              console.error('Copy failed:', e);
              downloadAllFiles(...files);
            }
            break;

          case 'download':
            downloadAllFiles(...files);
            break;

          default:
            // Try native sharing as fallback
            if (navigator.share) {
              try {
                await navigator.share({
                  files: files,
                  title: subject,
                  text: text
                });
              } catch (e) {
                console.error('Share failed:', e);
                downloadAllFiles(...files);
              }
            } else {
              downloadAllFiles(...files);
            }
        }
      } catch (error) {
        console.error('Share error:', error);
        alert('خطا در اشتراک‌گذاری. در حال دانلود مستقیم فایل‌ها...');
        downloadAllFiles(...files);
      }
    }

    // Add this helper function to check if the device is mobile
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Add this helper function to get the appropriate share URL
    function getShareUrl(method, files, text) {
      const baseUrls = {
        whatsapp: 'whatsapp://send',
        telegram: 'tg://msg',
        email: 'mailto:'
      };

      const url = new URL(baseUrls[method]);
      url.searchParams.append('text', text);
      
      return url.toString();
    }

    function downloadAllFiles(...files) {
      try {
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          z-index: 10000;
          text-align: center;
        `;
        loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال دانلود فایل‌ها...';
        document.body.appendChild(loadingDiv);

        // Process each file
        files.forEach((file, index) => {
          setTimeout(() => {
            downloadSingleFile(file, index + 1, files.length)
              .then(() => {
                if (index === files.length - 1) {
                  // Remove loading indicator after last file
                  document.body.removeChild(loadingDiv);
                }
              })
              .catch(error => {
                console.error(`Error downloading file ${index + 1}:`, error);
                // Try alternative download method
                tryAlternativeDownload(file, index + 1);
              });
          }, index * 1000); // Delay between files
        });
      } catch (error) {
        console.error('Error in downloadAllFiles:', error);
        alert('خطا در دانلود فایل‌ها. در حال تلاش با روش جایگزین...');
        tryFallbackDownload(files);
      }
    }

    async function downloadSingleFile(file, fileNum, totalFiles) {
      return new Promise(async (resolve, reject) => {
        try {
          // Create blob from file
          const blob = new Blob([file], { type: file.type });
          
          // Try using native download attribute first
          if ('download' in HTMLAnchorElement.prototype) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = file.name;
            
            // Special handling for iOS Safari
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
              link.target = '_blank';
              link.rel = 'noopener noreferrer';
            }
            
            // Append, click, and cleanup
            document.body.appendChild(link);
            link.click();
            
            // Cleanup after delay
            setTimeout(() => {
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              resolve();
            }, 1000);
          } else {
            // Fallback for browsers without download attribute support
            const reader = new FileReader();
            reader.onload = function(e) {
              const dataUrl = e.target.result;
              const win = window.open();
              if (win) {
                win.document.write(`
                  <html>
                    <head>
                      <title>دانلود فایل ${fileNum} از ${totalFiles}</title>
                    </head>
                    <body>
                      <p style="text-align: center;">
                        در حال دانلود فایل ${fileNum} از ${totalFiles}...
                        <br>
                        اگر دانلود به صورت خودکار شروع نشد، روی فایل کلیک راست کرده و گزینه "ذخیره به عنوان" را انتخاب کنید.
                      </p>
                      ${file.type.startsWith('image/') 
                        ? `<img src="${dataUrl}" alt="Downloaded Image">` 
                        : `<a href="${dataUrl}" download="${file.name}">دانلود فایل</a>`
                      }
                    </body>
                  </html>
                `);
              } else {
                // If popup blocked, try direct navigation
                window.location.href = dataUrl;
              }
              resolve();
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          }
        } catch (error) {
          reject(error);
        }
      });
    }

    function tryAlternativeDownload(file, fileNum) {
      try {
        // Create object URL and try download
        const blob = new Blob([file], { type: file.type });
        const url = URL.createObjectURL(blob);
        
        // Try using msSaveBlob for IE/Edge
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
          window.navigator.msSaveOrOpenBlob(blob, file.name);
          return;
        }
        
        // For iOS devices
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const win = window.open('', '_blank');
            if (win) {
              win.document.write(`
                <html>
                  <head>
                    <title>دانلود فایل ${fileNum}</title>
                  </head>
                  <body>
                    <p style="text-align: center;">برای ذخیره فایل، روی آن فشار طولانی دهید و گزینه "ذخیره تصویر" را انتخاب کنید.</p>
                    ${file.type.startsWith('image/') 
                      ? `<img src="${e.target.result}" alt="Downloaded Image">` 
                      : `<a href="${e.target.result}" download="${file.name}">دانلود فایل</a>`
                    }
                  </body>
                </html>
              `);
            }
          };
          reader.readAsDataURL(blob);
          return;
        }
        
        // For other browsers
        const link = document.createElement('a');
        link.href = url;
        link.download = file.name;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        
        // Cleanup
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 1000);
      } catch (error) {
        console.error('Alternative download failed:', error);
        alert(`خطا در دانلود فایل ${fileNum}. لطفاً مجدداً تلاش کنید.`);
      }
    }

    function tryFallbackDownload(files) {
      // Create a zip file containing all files
      try {
        // Load JSZip dynamically
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js';
        script.onload = async () => {
          const zip = new JSZip();
          
          // Add files to zip
          for (let file of files) {
            zip.file(file.name, file);
          }
          
          // Generate and download zip
          const content = await zip.generateAsync({type: 'blob'});
          const url = URL.createObjectURL(content);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'files.zip';
          document.body.appendChild(link);
          link.click();
          
          // Cleanup
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }, 1000);
        };
        document.head.appendChild(script);
      } catch (error) {
        console.error('Fallback download failed:', error);
        alert('خطا در دانلود فایل‌ها. لطفاً از مرورگر دیگری استفاده کنید.');
      }
    }

    // Update the direct download button handler
    async function downloadAllFilesDirectly() {
      const baseFileName = getFileName();
      
      try {
        // Show loading state
        const downloadBtn = document.getElementById('download-button');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال آماده‌سازی...';
        downloadBtn.disabled = true;

        // Create files
        const imageBlob = await tablesToImage();
        const csvBlob = new Blob([tablesToCSV()], { type: 'text/csv;charset=utf-8' });
        const csv2Blob = new Blob([tablesToCSV('table2')], { type: 'text/csv;charset=utf-8' });

        const files = [
          new File([imageBlob], `${baseFileName}.png`, { type: 'image/png' }),
          new File([csvBlob], `${baseFileName}.csv`, { type: 'text/csv' }),
          new File([csv2Blob], `${baseFileName} - جدول 2.csv`, { type: 'text/csv' })
        ];

        // Start download process
        downloadAllFiles(...files);

      } catch (error) {
        console.error('Error preparing files:', error);
        alert('خطا در آماده‌سازی فایل‌ها');
      } finally {
        // Restore button state
        const downloadBtn = document.getElementById('download-button');
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> دانلود فایل‌ها';
        downloadBtn.disabled = false;
      }
    }

    function saveTempData() {
      const formData = {
        // Basic info
        managerName: document.getElementById('manager-name').value,
        nationalCode: document.getElementById('national-code').value,
        signature: savedSignature,
        
        // Base info
        baseName: document.getElementById('base-name').value,
        baseType: document.getElementById('base-type').value,
        month: document.getElementById('month').value,
        year: document.getElementById('year').value,
      };
      
      localStorage.setItem('formData', JSON.stringify(formData));
      saveTableData();
    }

    function loadTempData() {
      const savedData = localStorage.getItem('formData');
      if (savedData) {
        const formData = JSON.parse(savedData);
        
        // Basic info
        document.getElementById('manager-name').value = formData.managerName || '';
        document.getElementById('national-code').value = formData.nationalCode || '';
        if (formData.signature) {
          savedSignature = formData.signature;
          const ctx = document.getElementById('signature-pad').getContext('2d');
          const img = new Image();
          img.onload = function() {
            ctx.drawImage(img, 0, 0);
          };
          img.src = formData.signature;
        }
        
        // Base info
        document.getElementById('base-name').value = formData.baseName || '';
        document.getElementById('base-type').value = formData.baseType || '';
        document.getElementById('month').value = formData.month || '';
        document.getElementById('year').value = formData.year || '';
      }
    }

    // Add auto-save functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Load saved data when page loads
      loadTempData();
      loadTableData();
      
      // Auto-save only specified fields when they change
      const savedFields = ['manager-name', 'national-code', 'base-name', 'base-type', 'month', 'year'];
      savedFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', saveTempData);
          element.addEventListener('blur', saveTempData);
        }
      });
      
      // Save specified data and clear other fields before page unload
      window.addEventListener('beforeunload', function() {
        saveTempData();
        clearSubmissionFields();
      });
    });

    function saveTableData() {
      try {
        const table1Data = Array.from(document.querySelectorAll('#table1 tbody tr')).map(row => {
          return Array.from(row.cells).map(cell => cell.innerHTML);
        });
        const table2Data = Array.from(document.querySelectorAll('#table2 tbody tr')).map(row => {
          return Array.from(row.cells).map(cell => cell.innerHTML);
        });
        const table3Data = Array.from(document.querySelectorAll('#table3 tbody tr')).map(row => {
          return Array.from(row.cells).map(cell => cell.innerHTML);
        });

        localStorage.setItem('table1Data', JSON.stringify(table1Data));
        localStorage.setItem('table2Data', JSON.stringify(table2Data));
        localStorage.setItem('table3Data', JSON.stringify(table3Data));
        
        // Save isFirstSubmission state
        localStorage.setItem('isFirstSubmission', JSON.stringify(isFirstSubmission));
        
        // Save signature if exists
        if (savedSignature) {
          localStorage.setItem('savedSignature', savedSignature);
        }
      } catch (error) {
        console.error('Error saving table data:', error);
      }
    }

    function loadTableData() {
      try {
        const table1Data = JSON.parse(localStorage.getItem('table1Data') || '[]');
        const table2Data = JSON.parse(localStorage.getItem('table2Data') || '[]');
        const table3Data = JSON.parse(localStorage.getItem('table3Data') || '[]');

        const table1Body = document.querySelector('#table1 tbody');
        const table2Body = document.querySelector('#table2 tbody');
        const table3Body = document.querySelector('#table3 tbody');

        if (table1Data.length > 0 || table2Data.length > 0 || table3Data.length > 0) {
          document.getElementById('results').style.display = 'block';
        }

        table1Body.innerHTML = table1Data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
        table2Body.innerHTML = table2Data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');
        table3Body.innerHTML = table3Data.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('');

        // Load isFirstSubmission state
        const savedIsFirstSubmission = localStorage.getItem('isFirstSubmission');
        if (savedIsFirstSubmission !== null) {
          isFirstSubmission = JSON.parse(savedIsFirstSubmission);
        }

        // Load saved signature
        const savedSig = localStorage.getItem('savedSignature');
        if (savedSig) {
          savedSignature = savedSig;
          if (!isFirstSubmission) {
            document.getElementById('signature-pad').style.pointerEvents = 'none';
            document.getElementById('clear-signature').disabled = true;
            document.getElementById('save-signature').disabled = true;
          }
        }

        // Reattach event listeners for edit and delete buttons
        reattachTableEventListeners();
        
        // If there's data, disable the first seven fields
        if (table1Data.length > 0) {
          disableFirstSevenFields();
        }
      } catch (error) {
        console.error('Error loading table data:', error);
      }
    }

    function clearTempData() {
      if (confirm('آیا مطمئن هستید که می‌خواهید داده‌های موقت را حذف کنید؟')) {
        localStorage.removeItem('formData');
        localStorage.removeItem('table1Data');
        localStorage.removeItem('table2Data');
        localStorage.removeItem('table3Data');
        localStorage.removeItem('isFirstSubmission');
        localStorage.removeItem('savedSignature');
        
        // Clear the table contents from the DOM
        document.querySelector('#table1 tbody').innerHTML = '';
        document.querySelector('#table2 tbody').innerHTML = '';
        document.querySelector('#table3 tbody').innerHTML = '';
        
        // Hide the results section
        document.getElementById('results').style.display = 'none';
        
        alert('داده‌های موقت حذف شدند.');
      }
    }

    function resetAllData() {
      if (confirm('آیا مطمئن هستید که می‌خواهید همه داده‌ها را پاک کنید؟')) {
        // Clear all localStorage data
        localStorage.clear();
        
        // Reset all form fields
        document.getElementById('manager-name').value = '';
        document.getElementById('manager-name').disabled = false;
        document.getElementById('national-code').value = '';
        document.getElementById('national-code').disabled = false;
        document.getElementById('base-name').value = '';
        document.getElementById('base-name').disabled = false;
        document.getElementById('base-type').value = '';
        document.getElementById('base-type').disabled = false;
        document.getElementById('month').value = '';
        document.getElementById('month').disabled = false;
        document.getElementById('year').value = '';
        document.getElementById('year').disabled = false;
        
        // Clear and re-enable signature pad
        if (signaturePad) {
          signaturePad.clear();
          document.getElementById('signature-pad').style.pointerEvents = 'auto';
        }
        document.getElementById('save-signature').disabled = false;
        document.getElementById('clear-signature').disabled = false;
        savedSignature = null;
        
        // Reset staff info
        document.getElementById('staff-name').value = '';
        document.getElementById('productive').checked = false;
        
        // Reset all shift counts
        const countFields = [
          'normal-24-count', 'holiday-24-count', 'long-day-count', 
          'holiday-long-day-count', 'night-count', 'holiday-night-count',
          'full-leave-count', 'medical-leave-count'
        ];
        countFields.forEach(field => {
          document.getElementById(field).value = '';
        });
        
        // Reset all date fields
        const dateFields = [
          'normal-24-date', 'holiday-24-date', 'long-day-date',
          'holiday-long-day-date', 'night-date', 'holiday-night-date',
          'full-leave-count', 'medical-leave-date'
        ];
        dateFields.forEach(field => {
          document.getElementById(field).value = '';
        });
        
        // Clear additional fields
        document.getElementById('additional-fields').innerHTML = '';
        
        // Reset other fields
        document.getElementById('notes').value = '';
        document.getElementById('mission-count').value = '';
        document.getElementById('meal-count').value = '';
        
        // Clear all tables
        document.querySelector('#table1 tbody').innerHTML = '';
        document.querySelector('#table2 tbody').innerHTML = '';
        document.querySelector('#table3 tbody').innerHTML = '';
        
        // Hide results section
        document.getElementById('results').style.display = 'none';
        
        // Reset submission state
        isFirstSubmission = true;
        currentEditRow = null;
        
        // Show success message
        alert('همه داده‌ها با موفقیت پاک شدند. می‌توانید از ابتدا شروع کنید.');
      }
    }

    function reattachTableEventListeners() {
      document.querySelectorAll('#table2 .edit-btn').forEach(btn => {
        btn.addEventListener('click', editRow);
      });

      document.querySelectorAll('#table2 .delete-btn').forEach(btn => {
        btn.addEventListener('click', deleteRow);
      });

      document.querySelectorAll('#table3 .edit-btn').forEach(btn => {
        btn.addEventListener('click', editRow);
      });

      document.querySelectorAll('#table3 .delete-btn').forEach(btn => {
        btn.addEventListener('click', deleteRow);
      });
    }
  </script>
</body>
</html>
